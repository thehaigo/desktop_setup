#!/usr/bin/env bash
set -euo pipefail

BASE=`pwd`
APP_FILE="$BASE/src/main/assets/app.zip"
export MIX_ENV=prod
export MIX_TARGET=android

cd ../../../


asdf set -u erlang 26.2.5
asdf set -u elixir 1.17.2-otp-26


export PATH="$HOME/.asdf/shims:$HOME/.asdf/bin:$PATH"


STRIP_SHIM_DIR="$(mktemp -d)"
cat > "${STRIP_SHIM_DIR}/strip" <<'EOS'
#!/usr/bin/env bash
# no-op strip to avoid breaking ELF .so on macOS
exit 0
EOS
chmod +x "${STRIP_SHIM_DIR}/strip"
export PATH="${STRIP_SHIM_DIR}:$PATH"
export STRIP=/usr/bin/true
export DEVELOPER_DIR=""

#mkdir -p "$(dirname "$APP_FILE")"
#rm -f "$APP_FILE"

#cd "$ELIXIR_DIR"


#rm -rf _build
mix do local.hex --force, local.rebar --force
mix deps.get

# (cd assets && npm ci && npm run build)

mix assets.deploy
mix release --overwrite

REL_DIR="_build/${MIX_TARGET}_${MIX_ENV}/rel/template_app"
[ -d "$REL_DIR" ] || { echo "Release dir not found: $REL_DIR"; exit 1; }

TMP_DIR="$(mktemp -d)"
rsync -a "$REL_DIR/" "$TMP_DIR/"
chmod -R u+w "$TMP_DIR"
( cd "$TMP_DIR" && zip -9r "$APP_FILE" lib/ releases/ --exclude "*.so" )

